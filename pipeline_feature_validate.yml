trigger: none
pr:
  - master

pool:
  vmImage: ubuntu-latest

stages:
 - stage: Validating
   displayName: 'Verifying...'
   jobs:
    - job: TestingFullBuild
      displayName: 'Testing Full DB Build'
      steps:
      
       - script: docker-compose up -d
         displayName: 'Full Build - Starting Docker Container'

       - script: docker-compose run --rm liquibase /liquibase/liquibase --defaultsFile "changelog/liquibase.properties" update
         displayName: 'Full Build - Running Liquibase Update'

    - job: TestingMigration
      displayName: 'Testing DB Migration'
      steps:

       - checkout: self
       
       - script: git switch master
       
       - script: docker-compose up -d
         displayName: 'Migration - Starting Docker Container'

       - script: docker-compose run --rm liquibase /liquibase/liquibase --defaultsFile "changelog/liquibase.properties" update
         displayName: 'Migration - Update DB To Master'

       - script: git checkout $BUILD_SOURCEVERSION

       - script: docker-compose run --rm liquibase /liquibase/liquibase --defaultsFile "changelog/liquibase.properties" status --verbose
         displayName: 'Migration - Feature Liquibase Status'

       - script: docker-compose run --rm liquibase /liquibase/liquibase --defaultsFile "changelog/liquibase.properties" updateSQL > update_${BUILD_BUILDNUMBER}.sql
         displayName: 'Migration - Generating Update SQL'

       - script: docker-compose run --rm liquibase /liquibase/liquibase --defaultsFile "changelog/liquibase.properties" update
         displayName: 'Migration - Update DB To Feature'

       - publish: $(System.DefaultWorkingDirectory)/update_$(Build.BuildNumber).sql
         artifact: update_sql
